<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>YouTube Live Playback Command Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: #0f0f0f;
      color: #f9f9f9;
      font-family: 'Inter', sans-serif;
    }
    input, textarea {
      background: #1a1a1a;
      color: #f9f9f9;
      border-radius: 0.5rem;
      padding: 0.6rem 0.8rem;
      font-size: 0.95rem;
      border: none;
      outline: none;
    }
    input:focus, textarea:focus {
      outline: 2px solid #e3342f;
    }
    button {
      background-color: #e3342f;
      border: none;
      padding: 0.6rem 1.3rem;
      border-radius: 0.5rem;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #cc1f1a;
    }
    .info-box {
      background: #1a1a1a;
      border-left: 4px solid #e3342f;
      padding: 0.8rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #ddd;
    }
    textarea#commandOutput {
      flex: 1;
      height: 6.2rem;
      background: #1a1a1a;
      color: #f9f9f9;
      border-radius: 0.5rem;
      padding: 0.6rem 1rem;
      font-family: monospace;
      font-size: 0.95rem;
      resize: none;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6 text-red-500">YouTube Live Playback Command Builder</h1>

  <!-- Caixa de informações -->
  <div class="info-box w-full max-w-3xl mb-4">
    ⚠️ <b>Atenção:</b><br>
    - Funciona apenas para <b>lives</b><br>
    - O tempo de recuperação é <b>curto</b><br>
    - Confirme o <b>tempo ativo</b> da live antes de baixar<br>
    - Use <b>.ts</b> para armazenar ou <b>.mp4</b> se for editar.
  </div>
<br>
  <!-- Container principal -->
  <div class="w-full max-w-4xl flex gap-6 items-start">
    
    <!-- Lado esquerdo - Thumbnail -->
    <div class="w-64 h-36 bg-gray-800 rounded-lg overflow-hidden flex items-center justify-center border border-gray-700">
      <img id="thumbnail" src="" alt="Preview" class="w-full h-full object-cover hidden">
      <span id="thumbPlaceholder" class="text-gray-500 text-sm">Thumbnail da live</span>
    </div>

    <!-- Lado direito - Formulário -->
    <div class="flex-1 flex flex-col gap-3">
      <input id="videoUrl" type="text" placeholder="Cole a URL do YouTube aqui..." 
        class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-red-500" />

      <div class="flex gap-3">
        <input id="startTime" type="text" placeholder="Início (hh:mm)" class="w-1/3 bg-gray-800 text-white rounded-lg px-3 py-2" />
        <input id="endTime" type="text" placeholder="Fim (hh:mm) — opcional" class="w-1/3 bg-gray-800 text-white rounded-lg px-3 py-2" />
        <input id="retryCount" type="number" placeholder="Tentativas — opcional" class="w-1/3 bg-gray-800 text-white rounded-lg px-3 py-2" />
      </div>

      <button id="generateBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg py-2">
        Gerar Comando
      </button>
<br>
      <div class="flex gap-2 mt-2">
        <textarea id="commandOutput" readonly placeholder="O comando aparecerá aqui..."></textarea>
        <button id="copyBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg px-5">Copiar</button>
      </div>
    </div>

  </div>

  <hr class="border-gray-700 w-3/4 my-8">

  <!-- Rodapé -->
  <div class="flex justify-center items-center gap-4">
    <a href="https://yt-playback.github.io/yt-playback/yt-pb.exe" 
       target="_blank" class="bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg px-5 py-2">
       Baixar Ferramenta
    </a>
    <span class="text-gray-400 font-bold">|</span>
    <a href="https://greasyfork.org/pt-BR/scripts/536335-unlock-yt-live-rewind" 
       target="_blank" class="bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg px-5 py-2">
       Habilitar DVR
    </a>
  </div>

<script>
const urlInput = document.getElementById("videoUrl");
const thumb = document.getElementById("thumbnail");
const thumbPlaceholder = document.getElementById("thumbPlaceholder");
const commandOutput = document.getElementById("commandOutput");
const copyBtn = document.getElementById("copyBtn");
const generateBtn = document.getElementById("generateBtn");
const startInput = document.getElementById("startTime");
const endInput = document.getElementById("endTime");
const retryInput = document.getElementById("retryCount");

// Preenche automaticamente o horário de início com a hora local atual
(function setInitialStartTime() {
  const now = new Date();
  startInput.value = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
})();

// Resolve links /live/ do YouTube e retorna o videoId real
async function resolveLiveRedirect(url) {
  if (/\/live\/?$/.test(url)) {
    try {
      const response = await fetch(url, { method: "GET", redirect: "follow" });
      const text = await response.text();
      const match = text.match(/"videoId":"([a-zA-Z0-9_-]{11})"/);
      if (match) return match[1];
    } catch (e) {
      console.warn("Erro ao resolver live redirect:", e);
    }
  }
  const match = url.match(/v=([a-zA-Z0-9_-]{11})/);
  return match ? match[1] : null;
}

// Atualiza a thumbnail assim que a URL é digitada
async function updateThumbnail() {
  const url = urlInput.value.trim();
  const videoId = await resolveLiveRedirect(url);

  if (videoId) {
    const thumbUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    thumb.src = thumbUrl;
    thumb.classList.remove("hidden");
    thumbPlaceholder.classList.add("hidden");
  } else {
    thumb.classList.add("hidden");
    thumbPlaceholder.classList.remove("hidden");
  }
}

urlInput.addEventListener("input", updateThumbnail);

// Sanitiza o título para arquivo
function sanitizeFileName(name) {
  return name.replace(/[\\/:*?"<>|]/g, "").trim();
}

// Busca título do vídeo usando o endpoint oEmbed
async function getYouTubeTitle(url) {
  try {
    const res = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
    if (res.ok) {
      const data = await res.json();
      return sanitizeFileName(data.title);
    }
  } catch (e) {
    console.warn("Não foi possível obter o título:", e);
  }
  return "output";
}

// Geração do comando
generateBtn.addEventListener("click", async () => {
  const url = urlInput.value.trim();
  const start = startInput.value.trim();
  const end = endInput.value.trim();
  const retries = retryInput.value.trim();

  if (!url || !start) {
    alert("Informe ao menos a URL e o horário de início.");
    return;
  }

  const title = await getYouTubeTitle(url);
  const now = new Date();
  const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
  const outputName = `"${title}_${dateStr}_${start.replace(':','')}.ts"`;

  let cmd = `yt-pb "${url}" -inicio ${start}`;
  if (end) cmd += ` -fim ${end}`;
  if (retries) cmd += ` -r ${retries}`;
  cmd += ` -O ${outputName}`;

  commandOutput.value = cmd;
});

// Copiar comando para a área de transferência
copyBtn.addEventListener("click", () => {
  if (commandOutput.value) {
    navigator.clipboard.writeText(commandOutput.value).then(() => {
      const oldText = copyBtn.textContent;
      copyBtn.textContent = "Copiado!";
      copyBtn.style.backgroundColor = "#16a34a";
      setTimeout(() => {
        copyBtn.textContent = oldText;
        copyBtn.style.backgroundColor = "#e3342f";
      }, 800);
    });
  }
});

</script>


</body>
</html>
